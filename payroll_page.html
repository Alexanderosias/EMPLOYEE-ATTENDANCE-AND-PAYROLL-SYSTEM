<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Payroll Page - Main Content</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <style>

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-card {
            background-color: #e0e7ff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
        }

        .summary-card.red {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .summary-card.green {
            background-color: #d1fae5;
            color: #065f46;
        }

        .summary-card p.label {
            margin: 0;
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
        }

        .summary-card p.value {
            margin: 0.5rem 0 0;
            font-size: 1.75rem;
            font-weight: 700;
            padding-top: 20px;
        }

        .payroll-dashboard {
            display: flex;
            flex-direction: column;
            max-width: 100%;
        }

        .payroll-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }

        .payroll-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .pay-period-display {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .tax-settings {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            max-width: 100%;
            overflow: hidden;
            font-size: 14px;
        }

        .tax-settings-header {
            background-color: #e5e7eb;
            padding: 0.75rem 1rem;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 1.125rem;
            color: #374151;
            transition: background-color 0.2s ease;
        }

        .tax-settings-header:hover {
            background-color: #d1d5db;
        }

        .tax-settings-content {
            padding: 1rem;
            background-color: #f9fafb;
            display: none;
            max-width: 100%;
            overflow-x: auto;
        }

        .tax-settings-content.active {
            display: block;
        }

        .tax-settings-content .section {
            margin-bottom: 1rem;
        }

        .tax-settings-content label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: #374151;
        }

        .tax-settings-content input,
        .tax-settings-content textarea {
            width: 100%;
            padding: 0.4rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-family: monospace, monospace;
            box-sizing: border-box;
            resize: vertical;
        }

        .tax-settings-content textarea {
            min-height: 200px;
            font-family: monospace, monospace;
        }

        .tax-settings-content a.tax-link {
            font-size: 0.75rem;
            color: #2563eb;
            text-decoration: underline;
            margin-left: 0.5rem;
            display: inline-flex;
            align-items: center;
        }

        .tax-settings-content a.tax-link svg {
            margin-left: 0.25rem;
            width: 12px;
            height: 12px;
        }

        .tax-settings-save-btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            max-width: 200px;
            transition: background-color 0.2s ease;
        }

        .tax-settings-save-btn:hover {
            background-color: #1d4ed8;
        }

        .payroll-table-container {
            overflow-x: auto;
            max-width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
        }

        table.payroll-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }

        table.payroll-table thead {
            background-color: #e5e7eb;
        }

        table.payroll-table th,
        table.payroll-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.875rem;
            border-bottom: 1px solid #d1d5db;
            white-space: nowrap;
        }

        table.payroll-table th {
            text-align: start;
            font-weight: 700;
            color: #374151;
            user-select: none;
        }

        table.payroll-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        table.payroll-table tbody tr.skipped {
            color: #9ca3af;
            background-color: #f3f4f6;
        }

        table.payroll-table button.action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        table.payroll-table button.skip-btn {
            background-color: #dc2626;
            color: white;
        }

        table.payroll-table button.skip-btn:hover {
            background-color: #b91c1c;
        }

        table.payroll-table button.include-btn {
            background-color: #2563eb;
            color: white;
        }

        table.payroll-table button.include-btn:hover {
            background-color: #1d4ed8;
        }

        .mark-paid-btn {
            background-color: #16a34a;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 1rem;
            max-width: 150px;
            transition: background-color 0.2s ease;
            align-self: flex-start;
        }

        .mark-paid-btn:disabled {
            background-color: #a7f3d0;
            cursor: not-allowed;
        }

        .mark-paid-btn:hover:not(:disabled) {
            background-color: #15803d;
        }

        .status-message {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #dc2626;
            display: none;
        }

        .status-message.success {
            color: #16a34a;
        }

        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }

            .payroll-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <a class="sidebar-header" href="#">
                <img src="img/adfc_logo_by_jintokai_d4pchwp-fullview.png" alt="Logo" class="logo" />
                <span class="app-name">EAAPS Admin</span>
            </a>
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="dashboard.html">
                            <img src="icons/home.png" alt="Dashboard" class="icon" />
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="employees_page.html">
                            <img src="icons/group.png" alt="Employees" class="icon" />
                            Employees
                        </a>
                    </li>
                    <li>
                        <a href="schedule_page.html">
                            <img src="icons/calendar-deadline-date.png" alt="Schedules" class="icon" />
                            Schedules
                        </a>
                    </li>
                    <li>
                        <a href="department_position.html">
                            <img src="icons/networking.png" alt="departments&Positions" class="icon" />
                            Departments and Positions
                        </a>
                    </li>
                    <li>
                        <a href="attendance_logs_page.html">
                            <img src="icons/clock.png" alt="Attendance Logs" class="icon" />
                            Attendance Logs
                        </a>
                    </li>
                    <li>
                        <a href="payroll_page.html">
                            <img src="icons/cash.png" alt="Payroll" class="icon" />
                            Payroll
                        </a>
                    </li>
                    <li>
                        <a href="qr_codes_and_snapshots.html">
                            <img src="icons/snapshot.png" alt="Qr&Snapshots" class="icon" />
                            QR and Snapshots
                        </a>
                    </li>
                    <li>
                        <a href="reports_page.html">
                            <img src="icons/clipboard.png" alt="Reports" class="icon" />
                            Reports
                        </a>
                    </li>
                    <li class="active">
                        <a href="#">
                            <img src="icons/user.png" alt="Profile" class="icon" />
                            Profile
                        </a>
                    </li>
                    <li>
                        <a href="settings_page.html">
                            <img src="icons/coghweel.png" alt="Settings" class="icon" />
                            Settings
                        </a>
                    </li>
                </ul>
            </nav>

            <a class="logout-btn" href="login.html">
                <img src="icons/sign-out-option.png" alt="Logout" class="logout-icon" />
                Logout
            </a>
        </aside>

        <main class="main-content">
            <header class="dashboard-header">
                <h2>PAYROLL</h2>
                <p id="current-datetime" aria-live="polite"></p>
            </header>

            <section class="summary-cards" aria-label="Payroll summary">
                <div class="summary-card blue">
                    <p class="label">Total Gross Pay</p>
                    <p class="value" id="total-gross-pay">₱0.00</p>
                </div>
                <div class="summary-card red">
                    <p class="label">Total Taxes & Deductions</p>
                    <p class="value" id="total-deductions">₱0.00</p>
                </div>
                <div class="summary-card green">
                    <p class="label">Total Net Pay</p>
                    <p class="value" id="total-net-pay">₱0.00</p>
                </div>
            </section>

            <section class="payroll-dashboard" aria-label="Payroll dashboard">
                <div class="payroll-header">
                    <h1>Payroll Dashboard</h1>
                    <p class="pay-period-display" id="pay-period-display">Pay Period: --</p>
                </div>

                <!-- Tax Rate Settings Panel -->
                <section class="tax-settings" aria-label="Tax rate settings">
                    <div id="tax-settings-header" tabindex="0" role="button" aria-expanded="false"
                        aria-controls="tax-settings-content" class="tax-settings-header"
                        aria-label="Toggle tax rate settings">
                        Tax Rate Settings
                        <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none"
                            stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            viewBox="0 0 24 24" aria-hidden="true" style="transition: transform 0.3s ease;">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div id="tax-settings-content" class="tax-settings-content" hidden>
                        <div class="section">
                            <h3>PhilHealth <a href="https://www.philhealth.gov.ph/" target="_blank" rel="noopener"
                                    class="tax-link" aria-label="PhilHealth official site">🔗</a></h3>
                            <label for="philhealth-rate">Rate</label>
                            <input type="number" step="0.001" id="philhealth-rate" value="0.05" />
                            <label for="philhealth-floor">Salary Floor</label>
                            <input type="number" id="philhealth-floor" value="10000" />
                            <label for="philhealth-ceiling">Salary Ceiling</label>
                            <input type="number" id="philhealth-ceiling" value="100000" />
                            <label for="philhealth-fixed-floor">Fixed Amount (Floor)</label>
                            <input type="number" id="philhealth-fixed-floor" value="500" />
                            <label for="philhealth-fixed-ceiling">Fixed Amount (Ceiling)</label>
                            <input type="number" id="philhealth-fixed-ceiling" value="5000" />
                        </div>
                        <div class="section">
                            <h3>Pag-IBIG <a href="https://www.pagibigfund.gov.ph/" target="_blank" rel="noopener"
                                    class="tax-link" aria-label="Pag-IBIG official site">🔗</a></h3>
                            <label for="pagibig-rate">Employee Rate</label>
                            <input type="number" step="0.001" id="pagibig-rate" value="0.02" />
                            <label for="pagibig-low-rate">Low-Income Rate</label>
                            <input type="number" step="0.001" id="pagibig-low-rate" value="0.01" />
                            <label for="pagibig-threshold">Low-Income Threshold</label>
                            <input type="number" id="pagibig-threshold" value="1500" />
                        </div>
                        <div class="section">
                            <h3>SSS Contribution Table (JSON) <a href="https://www.sss.gov.ph/" target="_blank"
                                    rel="noopener" class="tax-link" aria-label="SSS official site">🔗</a></h3>
                            <textarea id="sss-table" aria-label="SSS Contribution Table JSON" spellcheck="false"
                                rows="10" style="font-family: monospace; font-size: 0.85rem;">
[
  {"salaryRange":[0,3249.99],"sssContribution":135},
  {"salaryRange":[3250,3749.99],"sssContribution":157.5},
  {"salaryRange":[3750,4249.99],"sssContribution":180},
  {"salaryRange":[4250,4749.99],"sssContribution":202.5},
  {"salaryRange":[4750,5249.99],"sssContribution":225},
  {"salaryRange":[5250,5749.99],"sssContribution":247.5},
  {"salaryRange":[5750,6249.99],"sssContribution":270},
  {"salaryRange":[6250,6749.99],"sssContribution":292.5},
  {"salaryRange":[6750,7249.99],"sssContribution":315},
  {"salaryRange":[7250,7749.99],"sssContribution":337.5},
  {"salaryRange":[7750,8249.99],"sssContribution":360},
  {"salaryRange":[8250,8749.99],"sssContribution":382.5},
  {"salaryRange":[8750,9249.99],"sssContribution":405},
  {"salaryRange":[9250,9749.99],"sssContribution":427.5},
  {"salaryRange":[9750,10249.99],"sssContribution":450},
  {"salaryRange":[10250,10749.99],"sssContribution":472.5},
  {"salaryRange":[10750,11249.99],"sssContribution":495},
  {"salaryRange":[11250,11749.99],"sssContribution":517.5},
  {"salaryRange":[11750,12249.99],"sssContribution":540},
  {"salaryRange":[12250,12749.99],"sssContribution":562.5},
  {"salaryRange":[12750,13249.99],"sssContribution":585},
  {"salaryRange":[13250,13749.99],"sssContribution":607.5},
  {"salaryRange":[13750,14249.99],"sssContribution":630},
  {"salaryRange":[14250,14749.99],"sssContribution":652.5},
  {"salaryRange":[14750,15249.99],"sssContribution":675},
  {"salaryRange":[15250,15749.99],"sssContribution":697.5},
  {"salaryRange":[15750,16249.99],"sssContribution":720},
  {"salaryRange":[16250,16749.99],"sssContribution":742.5},
  {"salaryRange":[16750,17249.99],"sssContribution":765},
  {"salaryRange":[17250,17749.99],"sssContribution":787.5},
  {"salaryRange":[17750,18249.99],"sssContribution":810},
  {"salaryRange":[18250,18749.99],"sssContribution":832.5},
  {"salaryRange":[18750,19249.99],"sssContribution":855},
  {"salaryRange":[19250,19749.99],"sssContribution":877.5},
  {"salaryRange":[19750,20249.99],"sssContribution":900},
  {"salaryRange":[20250,20749.99],"sssContribution":922.5},
  {"salaryRange":[20750,21249.99],"sssContribution":945},
  {"salaryRange":[21250,21749.99],"sssContribution":967.5},
  {"salaryRange":[21750,22249.99],"sssContribution":990}
]
            </textarea>
                        </div>
                        <button id="save-tax-rates-btn" class="tax-settings-save-btn" type="button">Save Tax
                            Rates</button>
                    </div>
                </section>

                <div class="payroll-table-container" aria-label="Payroll records table">
                    <table class="payroll-table" role="table" aria-describedby="pay-period-display">
                        <thead>
                            <tr>
                                <th scope="col">Employee Name</th>
                                <th scope="col">Gross Pay</th>
                                <th scope="col">PhilHealth</th>
                                <th scope="col">SSS</th>
                                <th scope="col">Pag-IBIG</th>
                                <th scope="col">Other Deductions</th>
                                <th scope="col">Total Deductions</th>
                                <th scope="col">Net Pay</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="payroll-table-body">
                            <!-- Rows inserted by JS -->
                        </tbody>
                    </table>
                </div>

                <button id="mark-as-paid-btn" class="mark-paid-btn" disabled type="button">Mark as Paid</button>
                <div id="status-message" class="status-message" role="alert" aria-live="assertive"></div>
            </section>
        </main>
    </div>
    <script>
        // Toggle tax settings panel
        const taxSettingsHeader = document.getElementById('tax-settings-header');
        const taxSettingsContent = document.getElementById('tax-settings-content');
            const toggleIcon = document.getElementById('toggle-icon');

    taxSettingsHeader.addEventListener('click', () => {
      const expanded = taxSettingsHeader.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        taxSettingsContent.hidden = true;
        taxSettingsHeader.setAttribute('aria-expanded', 'false');
        toggleIcon.style.transform = 'rotate(0deg)';
      } else {
        taxSettingsContent.hidden = false;
        taxSettingsHeader.setAttribute('aria-expanded', 'true');
        toggleIcon.style.transform = 'rotate(180deg)';
      }
    });

    taxSettingsHeader.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        taxSettingsHeader.click();
      }
    });

    // Elements for payroll summary
    const totalGrossPaySpan = document.getElementById('total-gross-pay');
    const totalDeductionsSpan = document.getElementById('total-deductions');
    const totalNetPaySpan = document.getElementById('total-net-pay');
    const payrollTableBody = document.getElementById('payroll-table-body');
    const payPeriodDisplayP = document.getElementById('pay-period-display');
    const markAsPaidBtn = document.getElementById('mark-as-paid-btn');
    const statusMessageDiv = document.getElementById('status-message');

    // Tax rate inputs
    const philhealthRateInput = document.getElementById('philhealth-rate');
    const philhealthFloorInput = document.getElementById('philhealth-floor');
    const philhealthCeilingInput = document.getElementById('philhealth-ceiling');
    const philhealthFixedFloorInput = document.getElementById('philhealth-fixed-floor');
    const philhealthFixedCeilingInput = document.getElementById('philhealth-fixed-ceiling');
    const pagibigRateInput = document.getElementById('pagibig-rate');
    const pagibigLowRateInput = document.getElementById('pagibig-low-rate');
    const pagibigThresholdInput = document.getElementById('pagibig-threshold');
    const sssTableTextarea = document.getElementById('sss-table');
    const saveTaxRatesBtn = document.getElementById('save-tax-rates-btn');

    // Mock employees data
    const employees = [
      { id: 'emp1', name: 'John Doe', monthlySalary: 35000, isSkipped: false },
      { id: 'emp2', name: 'Jane Smith', monthlySalary: 32000, isSkipped: false },
      { id: 'emp3', name: 'Peter Jones', monthlySalary: 45000, isSkipped: false },
      { id: 'emp4', name: 'Mary Garcia', monthlySalary: 30000, isSkipped: false }
    ];

    // Default tax rates object
    let taxRates = null;

    // Utility functions
    function formatCurrency(num) {
      return `₱${num.toFixed(2)}`;
    }

    function calculatePhilHealth(monthlySalary) {
      if (!taxRates) return 0;
      const { rate, floor, ceiling, fixedAmountFloor, fixedAmountCeiling } = taxRates.philhealth;
      if (monthlySalary <= floor) return fixedAmountFloor;
      if (monthlySalary >= ceiling) return fixedAmountCeiling;
      return monthlySalary * rate;
    }

    function calculatePagIbig(monthlySalary) {
      if (!taxRates) return 0;
      const { employeeRate, lowIncomeEmployeeRate, lowIncomeThreshold } = taxRates.pagibig;
      const rate = monthlySalary > lowIncomeThreshold ? employeeRate : lowIncomeEmployeeRate;
      return monthlySalary * rate;
    }

    function calculateSSS(monthlySalary) {
      if (!taxRates) return 0;
      const sssTable = taxRates.sss;
      const entry = sssTable.find(row => monthlySalary >= row.salaryRange[0] && monthlySalary <= row.salaryRange[1]);
      return entry ? entry.sssContribution : 0;
    }

    function calculatePayroll(employee, isMonthly) {
      const grossPay = isMonthly ? employee.monthlySalary : employee.monthlySalary / 2;
      const philhealth = isMonthly ? calculatePhilHealth(employee.monthlySalary) : calculatePhilHealth(employee.monthlySalary) / 2;
      const sss = isMonthly ? calculateSSS(employee.monthlySalary) : calculateSSS(employee.monthlySalary) / 2;
      const pagibig = isMonthly ? calculatePagIbig(employee.monthlySalary) : calculatePagIbig(employee.monthlySalary) / 2;
      const otherDeductions = 0; // Placeholder
      const totalDeductions = philhealth + sss + pagibig + otherDeductions;
      const netPay = grossPay - totalDeductions;
      return { grossPay, philhealth, sss, pagibig, otherDeductions, totalDeductions, netPay };
    }

    // Render payroll table
    function renderTable(records) {
      payrollTableBody.innerHTML = '';

      if (records.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 9;
        td.textContent = 'No payroll records found.';
        td.style.textAlign = 'center';
        td.style.padding = '1rem';
        tr.appendChild(td);
        payrollTableBody.appendChild(tr);
        totalGrossPaySpan.textContent = '₱0.00';
        totalDeductionsSpan.textContent = '₱0.00';
        totalNetPaySpan.textContent = '₱0.00';
        markAsPaidBtn.disabled = true;
        return;
      }

      let totalGross = 0;
      let totalDeductions = 0;
      let totalNet = 0;

      records.forEach(record => {
        const tr = document.createElement('tr');
        if (record.isSkipped) {
          tr.classList.add('skipped');
          tr.innerHTML = `
            <td>${record.name}</td>
            <td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td>
            <td><button class="action-btn include-btn" data-id="${record.id}">Mark as Included</button></td>
          `;
        } else {
          tr.innerHTML = `
            <td>${record.name}</td>
            <td>${formatCurrency(record.grossPay)}</td>
            <td>${formatCurrency(record.philhealth)}</td>
            <td>${formatCurrency(record.sss)}</td>
            <td>${formatCurrency(record.pagibig)}</td>
            <td>${formatCurrency(record.otherDeductions)}</td>
            <td>${formatCurrency(record.totalDeductions)}</td>
            <td>${formatCurrency(record.netPay)}</td>
            <td><button class="action-btn skip-btn" data-id="${record.id}">Mark as Skipped</button></td>
          `;
          totalGross += record.grossPay;
          totalDeductions += record.totalDeductions;
          totalNet += record.netPay;
        }
        payrollTableBody.appendChild(tr);
      });

      totalGrossPaySpan.textContent = formatCurrency(totalGross);
      totalDeductionsSpan.textContent = formatCurrency(totalDeductions);
      totalNetPaySpan.textContent = formatCurrency(totalNet);
      markAsPaidBtn.disabled = false;

      // Add event listeners for skip/include buttons
      document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const empId = btn.getAttribute('data-id');
          toggleEmployeeSkip(empId);
        });
      });
    }

    // Toggle skip/include employee
    function toggleEmployeeSkip(empId) {
      const emp = employees.find(e => e.id === empId);
      if (!emp) return;
      emp.isSkipped = !emp.isSkipped;
      fetchPayrollRecords();
    }

    // Fetch payroll records and render
    function fetchPayrollRecords() {
      if (!taxRates) {
        // Initialize taxRates from inputs or defaults
        try {
          taxRates = {
            philhealth: {
              rate: parseFloat(philhealthRateInput.value),
              floor: parseFloat(philhealthFloorInput.value),
              ceiling: parseFloat(philhealthCeilingInput.value),
              fixedAmountFloor: parseFloat(philhealthFixedFloorInput.value),
              fixedAmountCeiling: parseFloat(philhealthFixedCeilingInput.value)
            },
            pagibig: {
              employeeRate: parseFloat(pagibigRateInput.value),
              lowIncomeEmployeeRate: parseFloat(pagibigLowRateInput.value),
              lowIncomeThreshold: parseFloat(pagibigThresholdInput.value)
            },
            sss: JSON.parse(sssTableTextarea.value)
          };
        } catch {
          taxRates = {
            philhealth: { rate: 0.05, floor: 10000, ceiling: 100000, fixedAmountFloor: 500, fixedAmountCeiling: 5000 },
            pagibig: { employeeRate: 0.02, lowIncomeEmployeeRate: 0.01, lowIncomeThreshold: 1500 },
            sss: []
          };
        }
      }

      // Assume monthly pay period for demo
      const isMonthly = true;

      const records = employees.map(emp => {
        if (emp.isSkipped) return { ...emp, isSkipped: true };
        const payroll = calculatePayroll(emp, isMonthly);
        return { ...emp, ...payroll, isSkipped: false };
      });

      renderTable(records);
      payPeriodDisplayP.textContent = `Pay Period: ${new Date().toLocaleDateString()}`;
    }

    // Save tax rates button handler
    saveTaxRatesBtn.addEventListener('click', () => {
      try {
        taxRates = {
          philhealth: {
            rate: parseFloat(philhealthRateInput.value),
            floor: parseFloat(philhealthFloorInput.value),
            ceiling: parseFloat(philhealthCeilingInput.value),
            fixedAmountFloor: parseFloat(philhealthFixedFloorInput.value),
            fixedAmountCeiling: parseFloat(philhealthFixedCeilingInput.value)
          },
          pagibig: {
            employeeRate: parseFloat(pagibigRateInput.value),
            lowIncomeEmployeeRate: parseFloat(pagibigLowRateInput.value),
            lowIncomeThreshold: parseFloat(pagibigThresholdInput.value)
          },
          sss: JSON.parse(sssTableTextarea.value)
        };
        statusMessageDiv.textContent = 'Tax rates saved successfully!';
        statusMessageDiv.classList.add('success');
        statusMessageDiv.style.display = 'block';
        setTimeout(() => {
          statusMessageDiv.style.display = 'none';
          statusMessageDiv.classList.remove('success');
        }, 3000);
        fetchPayrollRecords();
      } catch (e) {
        statusMessageDiv.textContent = 'Invalid JSON format for SSS table. Please correct and try again.';
        statusMessageDiv.classList.remove('success');
        statusMessageDiv.style.display = 'block';
      }
    });

    // Mark as Paid button handler
    markAsPaidBtn.addEventListener('click', () => {
      markAsPaidBtn.disabled = true;
      statusMessageDiv.textContent = 'Payroll marked as paid successfully!';
      statusMessageDiv.classList.add('success');
      statusMessageDiv.style.display = 'block';
      setTimeout(() => {
        statusMessageDiv.style.display = 'none';
        statusMessageDiv.classList.remove('success');
      }, 3000);
    });

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      fetchPayrollRecords();

      // Show current date/time in header
      const currentDateTime = document.getElementById('current-datetime');
      function updateDateTime() {
        currentDateTime.textContent = new Date().toLocaleString();
      }
      updateDateTime();
      setInterval(updateDateTime, 60000);
    });
  </script>
</body>

</html>
